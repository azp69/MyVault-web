<div class="modal fade" id="detailsDialog" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content custom-dark-modal">
        <div class="modal-header">
          <h5 class="modal-title" id="detailsDialogTitle">View / modify credentials</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
            <form id="detailsForm">
                <div class="form-group">
                    <label for="descriptioninput">Description</label>
                    <input type="text" class="form-control" id="detailsDialogDescriptionInput" name="description" placeholder="Description">
                 </div>
                <div class="form-group">
                  <label for="userinput">Username</label>
                  <input type="text" class="form-control" id="detailsDialogUsernameInput" name="username" placeholder="Username">
                </div>
                <div class="form-group">
                  <label for="passwordinput">Password</label>
                  <input type="password" class="form-control" id="detailsDialogPasswordInput" name="password" placeholder="Password">
                  <input type="hidden" id="detailsDialogIdInput" name="id">
                </div>
                <div class="form-group">
                  <label for="url">URL</label>
                  <input type="text" class="form-control" id="detailsDialogUrlInput" name="url" placeholder="http://">
                </div>
            </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="showPasswordBtn">Show password</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal" id="deleteCredentialsBtn">Delete</button>
          <button type="submit" class="btn btn-primary" id="saveCredentialsBtn">Save changes</button>
          
        </div>
      
      </div>
    </div>
  </div>

  <script>
  $('#showPasswordBtn').click(function()
  {
    if ($('#detailsDialogPasswordInput').attr('type') == 'text')
    {
      $('#detailsDialogPasswordInput').prop('type', 'password');
      $(this).text('Show password');
    }
    else
    {
      $('#detailsDialogPasswordInput').prop('type', 'text');
      $(this).text('Hide password');
    }
  });

  $('#deleteCredentialsBtn').click(function()
  {
      var c = new Credential();
      c.id = $('#detailsDialogIdInput').val();
      sendCredRequest("DELETE", c);
  });

  $('#saveCredentialsBtn').click(function()
  {
    var id = $('#detailsDialogIdInput').val();
    
    if (id == null || id == "") // Uusi credential
    {
      console.log("Uus cred");
      var c = new Credential();
      c.credentialDescription = $('#detailsDialogDescriptionInput').val();
      c.username = $('#detailsDialogUsernameInput').val();
      c.salt = AES.generateSalt();
      c.iv = AES.generateIv();
      var key = AES.generateKey (c.salt, masterPass);
      c.url = $('#detailsDialogUrlInput').val();

      var pwd = $('#detailsDialogPasswordInput').val();

      c.password = AES.encrypt(key, c.iv, pwd);

      sendCredRequest("CREATE", c);
    }
    else // Muokataan vanhaa
    {
      console.log("Vanha cred");
      var c = new Credential();
      c.id = $('#detailsDialogIdInput').val();
      c.credentialDescription = $('#detailsDialogDescriptionInput').val();
      c.username = $('#detailsDialogUsernameInput').val();
      c.salt = AES.generateSalt();
      c.iv = AES.generateIv();
      var key = AES.generateKey (c.salt, masterPass);
      c.url = $('#detailsDialogUrlInput').val();

      var pwd = $('#detailsDialogPasswordInput').val();

      c.password = AES.encrypt(key, c.iv, pwd);

      sendCredRequest("UPDATE", c);
    }

    $("#detailsDialog").modal('hide');
        
});
  

function sendCredRequest(reqType, Cred)
{
  var d = JSON.stringify(
          {
            "requestType" : reqType,
            "usertoken" : userToken,
            "requestData" : {
              "id" : Cred.id,
              "credentialDescription" : Cred.credentialDescription,
              "username" : Cred.username,
              "pwd" : Cred.password,
              "salt" : Cred.salt,
              "iv" : Cred.iv,
              "url" : Cred.url
            }
          });
          console.log("Tämä on pyyntö:" + d);

  $.ajax({
        url : "api/credentials/index.php",
        data : d,
        dataType : 'json',
        contentType : 'application/json',
        type : 'POST'
        }).done(function(result) 
        {
            // var obj = JSON.parse(result);
            if (result.message)
            {
                console.log(result);
            }
            else 
            {
              console.log("Onnistu");
              console.log(result);
            }
            loadCreds();
        }).fail(function( result )
        {
            console.log(result);
        });
}

  </script>